# 系统架构设计文档

## 架构总体设计

```
┌─────────────────────────────────────────────────────────────────┐
│                         外部应用客户端                              │
│                    (爬虫任务、Web UI等)                          │
└──────────────────────────┬──────────────────────────────────────┘
                          │ HTTP/REST API
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Express 服务层                             │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐  ┌───────────────┐ │
│  │  Cookie 路由      │  │  Monitor 路由    │  │  健康检查     │ │
│  └────────┬─────────┘  └────────┬─────────┘  └───────┬───────┘ │
│           │                    │                     │         │
│           └────────┬───────────┴──────────┬─────────┘         │
│                    ▼                      ▼                   │
├──────────────────────────────────────────────────────────────┤
│                   控制层 (Controllers)                          │
│  ┌──────────────────────┐        ┌──────────────────────┐   │
│  │ CookieController     │        │ MonitorController    │   │
│  └──────────┬───────────┘        └────────┬─────────────┘   │
└─────────────┼────────────────────────────┼─────────────────┘
              │                            │
              ▼                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                   业务层 (Services)                               │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────┐ │
│  │ CookieService    │  │ CleanupService   │  │MonitorService│ │
│  │                  │  │                  │  │              │ │
│  │・导入            │  │・自动清理        │  │・监控告警    │ │
│  │・获取随机        │  │・释放占用        │  │・健康检查    │ │
│  │・验证            │  │・定期检测        │  │・统计分析    │ │
│  │・批量操作        │  │・定时任务        │  │              │ │
│  └──────────┬───────┘  └────────┬─────────┘  └──────┬──────┘ │
└─────────────┼────────────────────┼──────────────────┼────────┘
              │                    │                  │
              └─────────┬──────────┴──────────┬───────┘
                        ▼                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                   数据层 (Models)                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              CookieModel (数据访问层)                      │  │
│  │  ・CRUD操作     ・批量操作     ・查询统计     ・事务处理   │  │
│  └────────────────────┬─────────────────────────────────────┘  │
└────────────────────────┼──────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                      MySQL 数据库                                │
│  ┌────────────────┐  ┌─────────────────┐  ┌────────────────┐  │
│  │ cookie_pool    │  │ cookie_logs     │  │ cookie_cycles  │  │
│  │ (主表)         │  │ (操作日志)      │  │ (周期管理)     │  │
│  └────────────────┘  └─────────────────┘  └────────────────┘  │
│  ┌────────────────┐  ┌─────────────────┐                      │
│  │cookie_cycle_   │  │ cookie_alerts   │                      │
│  │  progress      │  │ (监控告警)      │                      │
│  │(周期进度)      │  │                 │                      │
│  └────────────────┘  └─────────────────┘                      │
└─────────────────────────────────────────────────────────────────┘
```

## 数据库设计

### 表结构关系图

```
┌─────────────────────┐
│   cookie_pool       │ (主表)
├─────────────────────┤
│ id (PK)             │◄─┐
│ ip (UNIQUE)         │  │
│ cookie              │  │
│ status              │  │
│ is_using            │  │
│ ...                 │  │
└─────────────────────┘  │
       ▲                 │
       │                 │
       │           ┌─────┴─────────────┐
       │           │                   │
    ┌──┴──────────────────────┐  ┌──────┴──────────────┐
    │  cookie_logs            │  │ cookie_cycle_       │
    ├─────────────────────────┤  │   progress          │
    │ id (PK)                 │  ├─────────────────────┤
    │ cookie_id (FK)          │  │ id (PK)             │
    │ action                  │  │ cycle_id (FK)       │
    │ status                  │  │ cookie_id (FK) ─────┤────┐
    │ ...                     │  │ ...                 │    │
    └─────────────────────────┘  └─────────────────────┘    │
                                                              │
                            ┌──────────────────────────┐      │
                            │   cookie_cycles         │      │
                            ├──────────────────────────┤      │
                            │ id (PK)                  │◄─────┘
                            │ name                     │
                            │ start_time               │
                            │ end_time                 │
                            │ target_count             │
                            │ ...                      │
                            └──────────────────────────┘

                            ┌──────────────────────────┐
                            │   cookie_alerts          │
                            ├──────────────────────────┤
                            │ id (PK)                  │
                            │ level                    │
                            │ type                     │
                            │ message                  │
                            │ status                   │
                            │ ...                      │
                            └──────────────────────────┘
```

### 主要表说明

#### cookie_pool（Cookie池主表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| ip | VARCHAR(15) | IP地址（唯一约束）|
| cookie | LONGTEXT | Cookie字符串 |
| status | TINYINT | 状态（0-未使用，1-使用中，2-失效，3-黑名单） |
| is_using | BOOLEAN | 是否正在使用 |
| last_used_time | DATETIME | 最后使用时间 |
| last_check_time | DATETIME | 最后检测时间 |
| use_count | INT | 使用次数 |
| valid_until | DATETIME | 有效期至 |
| error_msg | VARCHAR(500) | 错误信息 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### cookie_logs（操作日志表）
用于记录所有Cookie的操作历史。

#### cookie_cycles（周期管理表）
用于管理爬取周期，包含周期的开始时间、结束时间、目标数量等。

#### cookie_alerts（监控告警表）
用于记录系统告警信息，支持多级别告警。

## 核心流程

### 1. Cookie导入流程

```
导入请求
   ▼
验证输入格式
   ▼
批量插入数据库 (事务)
   ▼
记录操作日志
   ▼
返回导入结果
```

### 2. 获取Cookie流程

```
请求随机Cookie
   ▼
查询未使用的Cookie (SELECT ... ORDER BY RAND() LIMIT 1)
   ▼
标记为使用中 (UPDATE is_using = TRUE)
   ▼
更新使用时间和次数
   ▼
返回Cookie信息 {id, ip, cookie}
```

### 3. Cookie检测流程

```
验证请求
   ▼
调用小红书API (with Cookie)
   ▼
根据响应判断有效性
   ▼
更新Cookie状态和错误信息
   ▼
记录检测日志
   ▼
返回检测结果
```

### 4. 定时清理流程

```
┌─────────────────────────────────┐
│   定时任务 (每小时执行)           │
└────────────────┬────────────────┘
                 ▼
      ┌──────────────────────┐
      │  清理过期Cookie      │
      │ (valid_until < NOW)  │
      └──────────┬───────────┘
                 ▼
      ┌──────────────────────┐
      │  释放占用Cookie      │
      │ (is_using=TRUE且     │
      │  last_used<30分钟前) │
      └──────────┬───────────┘
                 ▼
      ┌──────────────────────┐
      │  批量验证Cookie      │
      │ (可选，12小时一次)   │
      └──────────┬───────────┘
                 ▼
      ┌──────────────────────┐
      │  执行健康检查        │
      │ (1小时一次)          │
      └──────────────────────┘
```

### 5. 监控告警流程

```
健康检查
   ▼
收集池状态数据
   ▼
检查告警条件
   │
   ├─ 池为空 ──→ 创建CRITICAL告警
   │
   ├─ 无可用 ──→ 创建WARNING告警
   │
   ├─ 失效率>30% ──→ 创建WARNING告警
   │
   └─ 黑名单率>20% ──→ 创建INFO告警
         ▼
   防止重复告警
   (检查是否已存在未处理告警)
         ▼
   保存告警到数据库
         ▼
   返回检查结果
```

## 关键设计决策

### 1. 一IP一Cookie设计

**原因：**
- 防止同一IP下多个Cookie相互影响
- 便于代理管理（一个IP对应一个代理）
- 提高请求的独立性

**实现：**
```sql
UNIQUE KEY `uk_ip` (`ip`)
```

### 2. 三层架构模式

**层次划分：**
- **Route 层**：处理HTTP请求路由
- **Controller 层**：参数验证、响应格式化
- **Service 层**：业务逻辑实现
- **Model 层**：数据库访问

**好处：**
- 职责清晰，易于维护
- 易于单元测试
- 代码复用性高

### 3. 异步处理机制

**定时任务：**
```javascript
setInterval(() => {
  CleanupService.cleanupExpiredCookies();
  CleanupService.releaseStuckCookies();
}, 3600000); // 1小时
```

**好处：**
- 不阻塞主线程
- 自动化维护
- 减少人工干预

### 4. 事务管理

**批量操作使用事务：**
```javascript
connection.beginTransaction();
// 执行多条插入
connection.commit();
```

**好处：**
- 保证数据一致性
- 原子操作
- 失败可回滚

## 性能优化

### 1. 索引设计

```sql
KEY `idx_status` (`status`)           -- 快速过滤状态
KEY `idx_is_using` (`is_using`)       -- 快速找到使用中的
KEY `idx_created_at` (`created_at`)   -- 时间范围查询
```

### 2. 查询优化

- 使用 `RAND()` 随机获取时注意性能
- 对于大数据集考虑分页
- 避免全表扫描

### 3. 连接池

```javascript
connectionLimit: 10  // 连接池最大连接数
```

## 扩展性设计

### 支持的扩展

1. **接入消息队列**：将异步任务队列化
2. **集群部署**：支持多进程/多服务器
3. **缓存层**：添加Redis缓存热数据
4. **监控系统**：接入Prometheus/Grafana
5. **通知系统**：支持邮件、钉钉、企业微信告警

### 未来功能

1. 自适应代理池
2. Cookie智能推荐
3. 预测失效率告警
4. 区域性Cookie管理
5. 性能分析面板

## 安全考虑

### 1. 数据安全
- Cookie存储在数据库，建议添加加密
- 敏感信息在日志中脱敏

### 2. 访问控制
- 添加API认证（Token / OAuth）
- 实现访问频率限制

### 3. 日志审计
- 记录所有操作
- 支持审计日志查询

## 部署建议

### 开发环境
```
Node.js + MySQL + 单机部署
```

### 生产环境
```
┌──────────────┐
│  Nginx 反向代理 │
└────┬─────────┘
     │
  ┌──┴──┬──────┐
  ▼     ▼      ▼
Node1 Node2  Node3 (应用集群)
  │     │      │
  └──┬──┴──┬───┘
     │     │
   ┌─┴─┬───┴─┐
   ▼   ▼     ▼
 MySQL Redis 监控系统
```

## 总结

本系统采用模块化、分层的架构设计，具有以下特点：
- **高可用**：支持集群部署
- **易维护**：代码结构清晰
- **可扩展**：易于添加新功能
- **自动化**：定时任务自动运维
- **可观测**：完善的监控告警机制
